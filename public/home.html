<!DOCTYPE html>

<html>
  <head>
    <title>Home - {{SITE_NAME}} v{{VERSION}}</title>
    {{HTML_HEADERS}}
    <link rel="stylesheet" href="/css/home.css">
  </head>

  <body>
    <div id="error"></div>
    <textarea id="post-text" maxlength="280" placeholder="Enter your post here..."></textarea><br>
    <button id="post">Post</button><br>
    <button onclick="refresh()">Refresh</button><br><br>

    <div id="posts"></div>

    <script>
      let inc = 0, req = 0, end = false;

      dom("post").addEventListener("click", function() {
        this.setAttribute("disabled", "");
        dom("post-text").setAttribute("disabled", "");
        fetch("/api/post/create", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            "content": dom("post-text").value
          })
        })
          .then((response) => (response.json()))
          .then((json) => {
            if (json.success) {
              dom("post-text").value = "";
              refresh();
            } else {
              dom("post").removeAttribute("disabled")
              dom("post-text").removeAttribute("disabled")
              inc++;
              dom("error").innerText = "Something went wrong! Try again in a few moments...";
              setTimeout(() => { req++; if (req == inc) { dom("error").innerText = ""; }}, 3000);
              throw(err);
            }
          })
          .catch((err) => {
            dom("post").removeAttribute("disabled")
            dom("post-text").removeAttribute("disabled")
            inc++;
            dom("error").innerText = "Something went wrong! Try again in a few moments...";
            setTimeout(() => { req++; if (req == inc) { dom("error").innerText = ""; }}, 3000);
            throw(err);
          });
      });

      function refresh() {
        dom("posts").innerHTML = "";

        fetch("/api/post/following", {
          method: "GET",
          headers: {
            "Content-Type": "application/json"
          }
        })
          .then((response) => (response.json()))
          .then((json) => {
            end = json.end;
            for (const post in json.posts) {
              console.log(post)
              dom("posts").innerHTML += `
              <div>
                <div class="post-container">
                  <div class="username">@${json.posts[post].username}</div> - <div class="timestamp">${timeSince(json.posts[post].timestamp)} ago</div>
                  <div class="main-content">${json.posts[post].content}</div>
                </div>
              </div>`;
            }
            dom("post").removeAttribute("disabled")
            dom("post-text").removeAttribute("disabled")
          })
          .catch((err) => {
            dom("post").removeAttribute("disabled")
            dom("post-text").removeAttribute("disabled")
            inc++;
            dom("error").innerText = "Something went wrong loading the posts! Try again in a few moments...";
            setTimeout(() => { req++; if (req == inc) { dom("error").innerText = ""; }}, 5000);
            throw(err);
          });
      }

      refresh();
    </script>
  </body>
</html>
